# SSMO - Claude Code プロジェクトガイド

## プロジェクト概要
真三國無双Online風の **4v4 近接アクション対戦ゲーム**。
Unity 6.3 LTS (C#) + Netcode for GameObjects (NGO) で開発中。

## 最重要原則
1. **サーバー権威型**: ゲーム状態の正解はサーバーが持つ。クライアントの値は一切信用しない
2. **ネットワークは後付けできない**: 全ての機能はオンライン前提で設計・実装する
3. **固定ティック**: ゲームロジックは FixedUpdate 60Hz 固定。描画FPSは可変
4. **動くものを最速で作る**: 見た目より動作優先。箱人間でいいから動かす

## 技術スタック
- **エンジン**: Unity 6.3 LTS (6000.3.9f1)
- **言語**: C#
- **ネットワーク**: Netcode for GameObjects (NGO) 2.9.2
- **トランスポート**: Unity Transport
- **マルチテスト**: ParrelSync 1.5.2
- **ネットワーク統計**: Multiplayer Tools 2.2.8
- **認証/DB**: Firebase Auth / Firestore (将来)

## プロジェクト構造
```
C:\dev\SSMO/
├── Assets/
│   ├── Scripts/
│   │   ├── Netcode/        # ネットワーク同期・予測・補間・ラグ補正
│   │   ├── Combat/         # ヒット判定・ダメージ・コンボシステム
│   │   ├── Character/      # 移動・ステートマシン・アニメーション
│   │   ├── UI/             # HUD・メニュー・ロビー
│   │   ├── Shared/         # 定数・計算式・データ定義（サーバー/クライアント共有）
│   │   └── Server/         # サーバー専用ロジック・AI
│   ├── Prefabs/
│   ├── Scenes/
│   ├── Models/
│   ├── Materials/
│   └── Effects/
├── docs/                   # 設計ドキュメント
├── .gitattributes          # Git LFS 設定
└── README.md
```

## ネットワークアーキテクチャ

### ティックレート設計
| 項目 | 値 |
|------|------|
| ゲームロジック (FixedUpdate) | 60Hz 固定 (0.01667秒) |
| サーバーティック | 60Hz 固定 |
| クライアント→サーバー送信 | 30Hz |
| サーバー→クライアント配信 | 30Hz |
| 描画FPS | 可変 (60/120/144/無制限) |

### ラグ対策の3本柱
1. **クライアント予測**: 入力を即座にローカル実行。サーバー結果とズレたら巻き戻し再計算
2. **補間 (Interpolation)**: 他プレイヤーの位置を100ms遅延で滑らかに表示
3. **ラグコンペンセーション**: 攻撃時にサーバーが攻撃者の時刻まで巻き戻してヒット判定（最大150ms）

### 同期データ (毎ティック, 18 bytes/プレイヤー)
- 位置 (Vector3): 12 bytes
- 回転 (Y軸): 2 bytes
- ステート (enum): 1 byte
- コンボ段数: 1 byte
- HP: 2 bytes

## 戦闘システム

※ 詳細仕様は `docs/combat-spec.md` を参照

### コンボ構造
- 通常攻撃 (□): 無強化 N1→N4 / 連撃強化1回 N5 / 2回 N6 / 3回+無双MAX E6→E9
- チャージ攻撃 (△): N[x]→△ で C[x] に派生（C1〜C6、武器種固有）
- ダッシュ攻撃: 一定時間移動後に □ で発動（Nコンボとは別系統）
- ブレイクチャージ: 武器2装備時に L2 で武器切替攻撃
- 先行入力バッファ: 150ms
- コンボ受付ウィンドウ: 各攻撃モーションの最後30%フレーム

### ヒット判定フロー (近接)
1. クライアント: 攻撃入力 → ローカル予測実行 → 予測ヒットエフェクト
2. サーバー: 入力受信 → ラグコンペンセーション → Hitbox vs Hurtbox 判定
3. サーバー: ヒット確定 → 全クライアントに通知
4. クライアント: 予測が正しければそのまま / 外れたらエフェクト取消

### ダメージ計算式 (★サーバー側のみ★)
```
1. 攻撃倍率 = モーション倍率 × 属性倍率（チャージ攻撃のみ属性が乗る）
2. 基礎ダメージ = ATK × 攻撃倍率
3. 防御計算 = 基礎ダメージ × (100 / (100 + DEF))   ※斬属性は DEF=0
4. 空中補正 = 空中被弾時 ÷2
5. 根性補正 = HP青(50-100%):÷1 / HP黄(20-50%):÷1.5 / HP赤(0-20%):÷2
6. 最終ダメージ = 防御計算 ÷ 空中補正 ÷ 根性補正
7. 斬保証 = 斬属性の場合 max(最終ダメージ, 斬固定値)
8. 最低保証 = max(最終ダメージ, 1)
9. クリティカル = 5%確率で ×1.5
※ ガード成功時はダメージ0（完全カット）。計算自体をスキップする
※ ガード不可技は存在しない。崩し手段はめくり（背面攻撃）のみ
```

### 属性システム（5種 + 無属性）
- **属性同士の相性なし**
- **チャージ攻撃にのみ属性が乗る**（通常攻撃には乗らない）
- 炎: 燃焼（持続ダメージ、HP0にはしない）
- 氷: 凍結（確率発動、約2秒行動不能）
- 雷: 感電（受け身不可）+ 気絶（地上のみ約3秒行動不可）
- 風: 鈍足（移動低下+ジャンプ不可）
- 斬: 防御無視 + HP&無双両方にダメージ（攻撃側無双も減少）

### アーマーシステム（5段階）
| 段階 | 耐性 |
|------|------|
| 1 通常 | なし（全てのけぞる） |
| 2 矢耐性 | 雑魚の矢でのけぞらない |
| 3 N耐性 | 通常攻撃でのけぞらない |
| 4 SA | チャージでものけぞらない |
| 5 HA | 無双でものけぞらない |

※ アーマーはのけぞり無効化のみ。ダメージは常に通る

### ガード
- L1 押しっぱなしで正面180度を防御（ダメージ完全カット = 0ダメージ）
- 通常ガード時はノックバックあり（多少押される）
- **ガード不可技は存在しない**（無双乱舞・C1含め全てガード可能）
- **崩し手段はめくり（側面・背面攻撃）のみ**
- ガード移動可能（正面向いたまま）
- エレメンタルガード (EG): ガード中に△約1秒押し込みで発動、カウンター攻撃
- EG中はノックバックなし（その場で完全に受け止める）

### 武器種 (初期6種)
| 武器 | 射程 | 特徴 |
|------|------|------|
| 大剣 | 3m | 広範囲・高威力・遅い |
| 双剣 | 1.5m | 手数型・連撃コンボ |
| 槍 | 4.5m | 突き特化・リーチ戦 |
| 戟 | 3.5m | 打ち上げ・回転斬り |
| 拳 | 1m | 超近距離ラッシュ |
| 弓 | 100m | 遠距離射撃・牽制（サブ） |

### ステートマシン
**基本**: Idle / Move / Jump / JumpAttack
**攻撃**: Attack(N) / Charge(C) / DashAttack(D) / DashRush / BreakCharge
**防御**: Guard / GuardMove / EG準備 / EG完成 / EGCounter
**無双**: MusouCharge / Musou / TrueMusou
**被弾**: Hitstun / Launch / AirHitstun / AirRecover / Slam
**ダウン(4種)**: FaceDownDown(前のめり) / CrumbleDown(崩れ落ち) / SprawlDown(仰向け) / Stun(気絶)
**復帰**: Getup(起き上がり・無敵)
**状態異常**: Freeze(氷) / Electrified(雷) / Burn(炎) / Slow(風)
**死亡**: Dead

※ ステート遷移の最終決定権はサーバー
※ ヒットストップなし（常時戦闘が流れるスピード感を重視）

## 開発ロードマップ
- [x] **M0** (Week 1-2): リポジトリ & 環境構築
- [x] **M1** (Week 3-8): ネットワーク同期基盤（クライアント予測・補間・ラグ補正）
- [ ] **M2** (Week 9-22): 戦闘アクション（コンボ・ヒット判定・ガード・ジャンプ・無双）
- [ ] **M3** (Week 23-28): 4v4 対戦モード（マッチメイキング・マップ・AI）
- [ ] **M4** (Week 29-38): キャラクター & コンテンツ（武器種・育成・仙箪強化）
- [ ] **M5** (Week 39-44): インフラ & チート対策
- [ ] **M6** (Week 45-52): ポリッシュ & α版リリース

## 現在の状態 (M1 完了)
- M0: 環境構築完了（Unity 6.3 LTS + NGO 2.9.2 + ParrelSync 1.5.2）
- M1-1: NetworkPlayer Prefab（箱人間 + NetworkObject + CharacterController）
- M1-2: サーバー権威型 移動同期（NetworkVariable + ServerRpc）
- M1-3: クライアント予測 + リコンシリエーション（巻き戻し再計算）
- M1-4: 他プレイヤー補間表示（100ms遅延 + スナップ閾値）
- M1-5: ラグコンペンセーション基盤（ワールドスナップショット + 巻き戻しAPI）
- M1-6: ネットワーク統計HUD（RTT / PacketLoss）

## 次のタスク: M2 - 戦闘アクション
1. 通常攻撃コンボ (N1→N6) + コンボステートマシン + 先行入力バッファ
2. ヒット判定システム (Hitbox/Hurtbox + サーバー権威 + ラグ補正)
3. ヒットリアクション (のけぞり・打ち上げ・4種ダウン)
4. ガード & ジャンプ (ガード80%カット・めくり・ジャンプ離陸無敵)
5. チャージ攻撃 (C1→C6) + ダッシュ攻撃
6. 無双乱舞 & 真・無双 (ゲージMAX・HP赤で真無双・無敵)
7. 遠隔攻撃システム (投射物のサーバー権威同期)

※ 戦闘仕様の詳細は `docs/combat-spec.md` を参照

## コーディング規約

### 命名規則
- クラス名: PascalCase (例: `DamageCalculator`)
- メソッド: PascalCase (例: `CalculateDamage`)
- フィールド (private): camelCase with _ prefix (例: `_currentHealth`)
- フィールド (public): PascalCase (例: `MaxHealth`)
- 定数: UPPER_SNAKE_CASE (例: `MAX_PLAYERS`)
- enum値: PascalCase (例: `CharacterState.Idle`)

### コメント
- コードコメントは日本語で書く
- 設計意図（なぜこのアプローチか）を必ずコメントに含める

### ネットワーク関連の規約
- サーバー専用処理は `[ServerRpc]` または `if (IsServer)` で明示
- クライアント専用処理は `[ClientRpc]` または `if (IsClient)` で明示
- 共有ロジック (ダメージ計算等) は `Scripts/Shared/` に配置
- NetworkVariable には `[SerializeField]` ではなく NetworkVariable<T> を使用
- RPC メソッド名は `〜ServerRpc` / `〜ClientRpc` サフィックスを付ける

### ファイル配置ルール
- ネットワーク同期コード → `Scripts/Netcode/`
- 戦闘ロジック → `Scripts/Combat/`
- キャラ制御 → `Scripts/Character/`
- UI → `Scripts/UI/`
- サーバー/クライアント共有の定数・計算式 → `Scripts/Shared/`
- サーバー専用ロジック (AI等) → `Scripts/Server/`

### 重要な注意事項
- **ダメージ計算は必ずサーバー側で実行**。クライアント値を絶対に信用しない
- **無敵状態 (無双乱舞・ジャンプ離陸・起き上がり) はサーバーのみが管理**
- **ヒット判定はサーバー権威**。クライアントは演出（エフェクト）のみ
- **ステート遷移の最終決定権はサーバー**。クライアントは予測遷移するが否認されたら巻き戻る
- **投射物 (弓矢等) の衝突判定もサーバーで実行**
- **アーマー・属性・状態異常の管理はサーバー権威**

## 作業見積もり

タスク指示を受けたとき、コードを書き始める前に以下を提示すること：

| 項目 | 内容 |
|------|------|
| CC作業時間（予想） | 例: 25〜35分 |
| 変更ファイル数 | 例: 3ファイル（新規1 + 修正2） |
| 変更規模 | ★〜★★★★★（5段階） |
| テスト含む合計 | 例: 40分（コンパイル確認 + ParrelSync テスト含む） |

これにより開発者が待ち時間を有効活用できる。

## 参考リソース
- [Gabriel Gambetta: Fast-Paced Multiplayer](https://www.gabrielgambetta.com/client-server-game-architecture.html) - ネットコードの必読資料
- [Unity NGO Documentation](https://docs-multiplayer.unity3d.com/netcode/current/about/) - 公式ドキュメント
- [GDC: Overwatch Gameplay Architecture and Netcode](https://www.youtube.com/watch?v=W3aieHjyNvw) - ラグ補正の実例
- [Valve: Source Multiplayer Networking](https://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking) - クライアント予測の原典

## 進捗管理
- タスク完了時は `docs/progress.html` の `PROGRESS_DATA` を更新すること
- 更新対象: `status`, `details[].done`, `lastUpdated`, マイルストーンの `progress`
- status は "done" / "inprogress" / "todo" のいずれか
- コミット時に progress.html の更新も含めること

## コミットルール
- タスク完了時は自動で `git add -A && git commit && git push` まで実行すること
- コミットメッセージ形式: "M[番号]-[サブ番号]: [タスク名]"
- 例: "M1-4: 他プレイヤー補間表示"
- ユーザーの承認を待たずに実行すること
