# M2-5b: サーバー判定 + ラグコンペンセーション連携

## 概要
M2-5a の HitboxSystem にラグコンペンセーションを連携させる。
攻撃者のタイムスタンプ時点の敵位置を復元してヒット判定を行う。

## 事前確認
- HitboxSystem.cs の CheckHitbox() を確認
- M1 で作成したラグコンペンセーション基盤（PositionHistory / LagCompensation）を確認
- GameConfig.cs の既存定数を確認

---

## 1. GameConfig.cs に定数追加

```csharp
// === ラグコンペンセーション ===
public const float MAX_LAG_COMPENSATION_MS = 150f;   // 最大巻き戻し時間（ms）（既存なら確認のみ）
```

---

## 2. HitboxSystem.cs の修正

### CheckHitbox() の修正
- 攻撃者の RTT（往復遅延）を取得
- 攻撃者のタイムスタンプを計算（現在時刻 - RTT/2）
- LagCompensation システムに巻き戻しリクエスト
- 巻き戻し後の敵位置で OverlapCapsule を実行
- 判定後に位置を元に戻す

### フロー
```
1. 攻撃入力を受信（タイムスタンプ付き）
2. タイムスタンプが MAX_LAG_COMPENSATION_MS 以内か検証
3. 全敵プレイヤーの位置を攻撃者タイムスタンプ時点に巻き戻し
4. 巻き戻し位置で Hitbox vs Hurtbox 判定
5. 位置を現在に復元
6. ヒット結果を確定
```

### クライアント予測ヒット
- 攻撃側クライアント: ローカルで予測ヒット → 即座にヒットエフェクト（仮表示）
- サーバー確認後: 正解→維持 / 外れ→取消
- NotifyHitClientRpc() でヒット確定を全クライアントに通知

---

## 3. テスト内容
1. **ParrelSync で2人接続** → 攻撃してヒットログが出る
2. **遠距離から攻撃** → ヒットしない
3. **ラグコンペンセーションのログ** → 巻き戻し時間が表示される

---

## 4. 完了条件
- [ ] ラグコンペンセーション付きのヒット判定が動作する
- [ ] MAX_LAG_COMPENSATION_MS を超えるリクエストは破棄される
- [ ] クライアントにヒット通知が届く
- [ ] 既存動作が壊れていない
- [ ] git commit & push: "M2-5b: ラグコンペンセーション連携"
