# ネットコード設計書

## アーキテクチャ概要
```
[Client A] ←→ [Dedicated Server] ←→ [Client B]
  予測実行       権威・判定          補間表示
```

## ティックレート設計
| 項目 | 値 | 備考 |
|------|------|------|
| ゲームロジック | 60Hz 固定 | FixedUpdate (0.01667秒) |
| サーバーティック | 60Hz 固定 | ロジックと同期 |
| クライアント→サーバー | 30Hz | 入力2ティック分まとめて送信 |
| サーバー→クライアント | 30Hz | 状態同期（補間で滑らか化） |
| 描画FPS | 可変 | 60/120/144/無制限 選択可 |

## 同期データ（毎ティック）
| データ | サイズ | 備考 |
|--------|--------|------|
| プレイヤー位置 (Vector3) | 12 bytes | |
| プレイヤー回転 (Y軸) | 2 bytes | 圧縮 |
| 現在ステート (enum) | 1 byte | |
| コンボ段数 | 1 byte | |
| HP | 2 bytes | |
| **合計/人** | **18 bytes** | |
| **8人 × 30Hz** | **≈ 4.3 KB/秒** | 十分軽量 |

## クライアント予測 & リコンシリエーション
1. クライアント: 入力 → ローカルで即実行（予測）
2. 入力をサーバーへ送信（ティック番号付き）
3. サーバー: 入力処理 → 正しい状態を算出
4. サーバー → 全クライアントに状態配信
5. クライアント: サーバー状態と予測を比較
6. ズレていたら → 該当ティックまで巻き戻し → 再シミュレーション

## ラグコンペンセーション（近接攻撃）
1. クライアント: 攻撃入力 + タイムスタンプ送信
2. サーバー: タイムスタンプ時点のワールド状態を復元
3. 復元した位置で Hitbox vs Hurtbox 判定
4. ヒット確定 → 全員に通知
- **最大補正時間: 150ms**（それ以上は切り捨て）

## レイテンシ別 品質ターゲット
| Ping | 品質 | 備考 |
|------|------|------|
| 0〜30ms | ★★★★★ | ほぼオフライン同等 |
| 30〜80ms | ★★★★☆ | 快適 |
| 80〜150ms | ★★★☆☆ | プレイ可能 |
| 150〜200ms | ★★☆☆☆ | ガード/回避が厳しい |
| 200ms超 | ★☆☆☆☆ | 非推奨・警告表示 |
