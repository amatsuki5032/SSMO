# M2-3b: 先行入力バッファ + コンボ受付ウィンドウ

## 概要
M2-3a のコンボシステムに先行入力バッファ（150ms）を追加する。
コンボ受付ウィンドウが開く前に押した入力を保持し、ウィンドウが開いた瞬間に自動消費する。

## 事前確認
- ComboSystem.cs の現在のコードを確認（M2-3a で作成済み）
- GameConfig.cs の INPUT_BUFFER_TIME を確認
- docs/combat-spec.md セクション3 を参照

---

## 1. ComboSystem.cs に先行入力バッファを追加

### サーバー側で管理するデータ（追加）
- `_inputBufferTimer`（float）: 先行入力の残り有効時間
- `_hasBufferedAttack`（bool）: バッファに攻撃入力があるか

### TryStartAttack() の修正
- コンボ受付ウィンドウが閉じている場合:
  - 即座にコンボを進めるのではなく `_hasBufferedAttack = true`, `_inputBufferTimer = INPUT_BUFFER_TIME` にする
  - Console ログ: `[Combo] 先行入力バッファリング`
- コンボ受付ウィンドウが開いている場合:
  - 即座にコンボを進める（現状と同じ）

### UpdateCombo() の修正
- _hasBufferedAttack == true のとき:
  - _inputBufferTimer を減算
  - _inputBufferTimer <= 0 → バッファクリア（`_hasBufferedAttack = false`）
  - コンボ受付ウィンドウが開いた瞬間に _hasBufferedAttack が true なら → 自動的にコンボ進行
  - Console ログ: `[Combo] バッファ消費 → N{step}`

### コンボ終了時のクリア
- コンボ終了時に `_hasBufferedAttack = false`, `_inputBufferTimer = 0` にリセット

---

## 2. 先行入力の動作フロー

```
プレイヤーの操作:
1. 左クリック → N1 開始（攻撃モーション中）
2. N1 の途中で左クリック（ウィンドウ前）→ バッファに保存
3. N1 のウィンドウ（最後30%）に到達 → バッファを消費して N2 に自動遷移
4. N2 の途中で左クリック → またバッファに保存
5. ...繰り返し

タイムアウト:
- バッファに入れてから 150ms 以内にウィンドウが開かない → バッファ破棄
```

---

## 3. テスト内容
1. **素早い連打**: N1 中に連打 → ウィンドウが開いた瞬間に N2 に遷移（スムーズ）
2. **早すぎる入力**: N1 開始直後に押す → バッファログが出る → ウィンドウ到達で消費
3. **遅すぎる入力**: N1 終了後に押す → 新しい N1 として開始
4. **バッファタイムアウト**: N1 開始直後に押す（持続時間が長い技の場合）→ 150ms経過でバッファ破棄 → ウィンドウ到達時に入力なしでコンボ終了
5. **既存動作維持**: 通常の連打もスムーズに繋がる

---

## 4. 完了条件
- [ ] 先行入力がバッファされる
- [ ] ウィンドウ到達時にバッファが自動消費される
- [ ] 150ms 経過でバッファが破棄される
- [ ] コンボ終了時にバッファがクリアされる
- [ ] 通常の連打操作が引き続きスムーズ
- [ ] git commit & push: "M2-3b: 先行入力バッファ"
